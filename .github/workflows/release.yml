name: ğŸ·ï¸ Release Management

on:
  release:
    types: [published]

jobs:
  validate-release:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ï¿½ Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… Validate release images exist
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          REPO_NAME="${{ github.repository }}"

          echo "ğŸ” Validating images for release: $TAG_NAME"

          # Check Ubuntu image
          if docker manifest inspect ghcr.io/${REPO_NAME}:${TAG_NAME}-ubuntu >/dev/null 2>&1; then
            echo "âœ… Ubuntu image exists: ghcr.io/${REPO_NAME}:${TAG_NAME}-ubuntu"
          else
            echo "âŒ Ubuntu image missing: ghcr.io/${REPO_NAME}:${TAG_NAME}-ubuntu"
            exit 1
          fi

          # Check Alpine image
          if docker manifest inspect ghcr.io/${REPO_NAME}:${TAG_NAME}-alpine >/dev/null 2>&1; then
            echo "âœ… Alpine image exists: ghcr.io/${REPO_NAME}:${TAG_NAME}-alpine"
          else
            echo "âŒ Alpine image missing: ghcr.io/${REPO_NAME}:${TAG_NAME}-alpine"
            exit 1
          fi

          echo "ğŸ‰ All release images validated successfully!"

      - name: ğŸ§ª Quick functionality test
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          REPO_NAME="${{ github.repository }}"

          # Test Ubuntu image
          echo "ğŸ§ª Testing Ubuntu image..."
          docker run --rm ghcr.io/${REPO_NAME}:${TAG_NAME}-ubuntu terraform version
          docker run --rm ghcr.io/${REPO_NAME}:${TAG_NAME}-ubuntu kubectl version --client

          # Test Alpine image
          echo "ğŸ§ª Testing Alpine image..."
          docker run --rm ghcr.io/${REPO_NAME}:${TAG_NAME}-alpine terraform version
          docker run --rm ghcr.io/${REPO_NAME}:${TAG_NAME}-alpine kubectl version --client

          echo "âœ… Release images tested successfully!"

  notify-release:
    runs-on: ubuntu-latest
    needs: validate-release
    if: always()

    steps:
      - name: ğŸ“¢ Release notification
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}

          if [ "${{ needs.validate-release.result }}" == "success" ]; then
            echo "âœ… Release $TAG_NAME validated and ready!"
            echo "ğŸ“¦ Images:"
            echo "  - ghcr.io/${{ github.repository }}:${TAG_NAME}-ubuntu"
            echo "  - ghcr.io/${{ github.repository }}:${TAG_NAME}-alpine"
          else
            echo "âŒ Release $TAG_NAME validation failed!"
            exit 1
          fi
